name: Build Enterprise EXE

# 触发机制：提交代码或手动点击
on: [push, workflow_dispatch]

jobs:
  build:
    # 指定使用 Windows Server 2022 环境
    runs-on: windows-latest

    steps:
    # 1. 拉取代码仓库
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. 配置 Python 3.9 (最稳定的打包版本)
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. 安装依赖 (增加重试机制防止网络波动)
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 4. 执行打包 (最关键的一步)
    # 这里的命令我特意写成了一整行，防止换行符错误
    # --collect-all: 强制把 paddleocr 所有的资源文件、模型配置都抓取进来
    # --add-data: 把你的 html 和 json 配置打包进去
    - name: Build with PyInstaller
      run: pyinstaller --noconsole --onefile --name="PrintBet_Pro" --add-data "templates;templates" --add-data "mappings.json;." --collect-all paddleocr --collect-all pyclipper --collect-all imghdr --collect-all paddle app.py

    # 5. 调试：如果打包失败，列出目录看看哪里错了 (可选)
    - name: Debug Directory (On Failure)
      if: failure()
      run: dir /s

    # 6. 整理输出文件
    # 我们把生成的 EXE 和 配置文件 单独拿出来放到 release 文件夹
    - name: Prepare Artifacts
      run: |
        mkdir release
        copy dist\PrintBet_Pro.exe release\
        if exist mappings.json copy mappings.json release\

    # 7. 上传最终结果供下载
    - name: Upload Final EXE
      uses: actions/upload-artifact@v4
      with:
        name: PrintBet_Enterprise_Edition
        path: release/
