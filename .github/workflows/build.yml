name: Build Enterprise EXE

# 触发机制
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. 拉取代码
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. 配置 Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. 安装依赖
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 4. 执行打包 (PaddleOCR 增强版)
    - name: Build with PyInstaller
      run: pyinstaller --noconsole --onefile --name="PrintBet_Pro" --add-data "templates;templates" --add-data "mappings.json;." --collect-all paddleocr --collect-all pyclipper --collect-all imghdr --collect-all paddle app.py

    # 5. 整理输出文件 (关键修正点)
    # 添加了 shell: cmd，强制使用 CMD 语法，解决 if exist 报错
    - name: Prepare Artifacts
      shell: cmd
      run: |
        if not exist release mkdir release
        copy dist\PrintBet_Pro.exe release\
        if exist mappings.json copy mappings.json release\

    # 6. 上传最终结果
    - name: Upload Final EXE
      uses: actions/upload-artifact@v4
      with:
        name: PrintBet_Enterprise_Edition
        path: release/
