<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•æ³¨å·¥åŠ (PrintBet Studio)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif; background: #f0f2f5; font-size: 13px; user-select: none; }
        /* è¡¨æ ¼æ ·å¼ */
        .data-table th { background: #e9ecef; padding: 8px; border: 1px solid #dee2e6; font-weight: bold; color: #495057; }
        .data-table td { padding: 6px 8px; border: 1px solid #dee2e6; background: #fff; color: #212529; }
        .data-table tr:nth-child(even) td { background: #f8f9fa; }
        .data-table tr:hover td { background: #e2e6ea; }
        textarea { font-family: 'Consolas', 'Courier New', monospace; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="bg-slate-800 text-white px-4 py-3 flex items-center justify-between shadow-md z-10">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ²</span>
                <div>
                    <div class="font-bold text-lg tracking-wide leading-none">æŠ•æ³¨å·¥åŠ</div>
                    <div class="text-[10px] text-slate-400 leading-none mt-1">PrintBet Enterprise v2.0</div>
                </div>
            </div>
            <div class="h-8 w-px bg-slate-600 mx-2"></div>
            <div class="flex gap-2">
                <button onclick="importMock()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs border border-slate-600 transition">ğŸ“„ å¯¼å…¥æ¼”ç¤ºæ•°æ®</button>
            </div>
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-400">
            <span class="w-2 h-2 rounded-full bg-green-500"></span>
            <span>ç³»ç»Ÿå°±ç»ª</span>
        </div>
    </div>

    <!-- ä¸»å·¥ä½œåŒº -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- å·¦ä¾§ï¼šæ•°æ®å½•å…¥ -->
        <div class="w-[400px] flex flex-col border-r border-slate-300 bg-white p-3 shadow-inner z-0">
            <div class="flex justify-between mb-2 items-end">
                <label class="font-bold text-slate-700 text-sm border-l-4 border-blue-600 pl-2">åŸå§‹å•æ®å½•å…¥</label>
                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">æ ¼å¼: åœºæ¬¡-é€‰é¡¹ (å¦‚ 3001-3)</span>
            </div>
            
            <textarea id="rawInput" class="flex-1 border border-slate-300 p-3 resize-none text-slate-800 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-sm rounded transition" 
                placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬...&#10;ç¤ºä¾‹ï¼š&#10;3001-3&#10;3002-1,0&#10;å‘¨ä¸‰003:2:1"></textarea>
            
            <div class="mt-3 bg-slate-50 p-3 rounded border border-slate-200">
                <div class="text-xs font-bold text-slate-500 mb-2 uppercase">è§£æè®¾ç½®</div>
                <div class="flex gap-2">
                    <select id="delimiter" class="border border-slate-300 p-2 rounded w-32 text-sm outline-none focus:border-blue-500">
                        <option value="-">åˆ†éš”ç¬¦: -</option>
                        <option value=":">åˆ†éš”ç¬¦: :</option>
                        <option value=" ">åˆ†éš”ç¬¦: ç©ºæ ¼</option>
                    </select>
                    <button onclick="parseText()" class="flex-1 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-2 rounded font-bold shadow transition flex items-center justify-center gap-2">
                        <span>âš¡</span> å¼€å§‹è§£æ
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šåˆ—è¡¨ä¸æ“ä½œ -->
        <div class="flex-1 flex flex-col bg-slate-100 p-3">
            <!-- åˆ—è¡¨å¤´éƒ¨æ§åˆ¶ -->
            <div class="flex justify-between mb-3 items-center bg-white p-2 rounded border border-slate-200 shadow-sm">
                <label class="font-bold text-slate-700 text-sm border-l-4 border-green-500 pl-2">å¾…æ‰“å°åˆ—è¡¨</label>
                <div class="flex gap-3 items-center bg-slate-50 px-3 py-1 rounded border border-slate-200">
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-slate-600">ç»Ÿä¸€è¿‡å…³:</label>
                        <select id="gPass" class="border border-slate-300 p-1 rounded w-20 text-sm outline-none"><option>1x1</option><option>2x1</option><option>3x1</option></select>
                    </div>
                    <div class="w-px h-4 bg-slate-300"></div>
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-slate-600">ç»Ÿä¸€å€æ•°:</label>
                        <input id="gMulti" type="number" value="10" class="border border-slate-300 p-1 rounded w-16 text-center text-sm outline-none font-bold text-blue-600">
                    </div>
                </div>
            </div>
            
            <!-- è¡¨æ ¼åŒºåŸŸ -->
            <div class="flex-1 overflow-auto border border-slate-300 bg-white rounded shadow-sm">
                <table class="w-full data-table text-left border-collapse">
                    <thead class="sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="w-12 text-center">åºå·</th>
                            <th class="w-24">åŸå§‹åœºæ¬¡</th>
                            <th class="w-24">æ ‡å‡†ç¼–ç </th>
                            <th>è§£æè¯¦æƒ… (åœºæ¬¡ > ç©æ³• = é€‰é¡¹)</th>
                            <th class="w-20 text-center">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="listBody">
                        <tr>
                            <td colspan="5" class="text-center text-slate-400 py-10">æš‚æ— æ•°æ®ï¼Œè¯·åœ¨å·¦ä¾§å½•å…¥å¹¶ç‚¹å‡»è§£æ</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åº•éƒ¨æ§åˆ¶å° -->
            <div class="h-36 mt-3 flex gap-3">
                <!-- æ—¥å¿— -->
                <div class="flex-1 bg-slate-900 text-green-400 p-3 font-mono text-xs overflow-y-auto rounded border border-slate-700 shadow-inner leading-relaxed" id="logs">
                    <span class="text-slate-500"># ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ...</span><br>
                    <span class="text-slate-500"># ç­‰å¾…ç”¨æˆ·æ“ä½œ...</span><br>
                </div>
                
                <!-- å‡ºç¥¨æŒ‰é’®åŒº -->
                <div class="w-56 flex flex-col gap-2 bg-white p-3 rounded border border-slate-200 shadow-sm">
                    <div class="flex justify-between text-sm border-b border-slate-100 pb-2 mb-1">
                        <span class="text-slate-600 font-bold">æœ‰æ•ˆå•æ•°:</span> 
                        <span id="validCount" class="text-blue-600 font-bold text-lg leading-none">0</span>
                    </div>
                    <button onclick="startBatchPrint()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold rounded text-lg shadow transition flex flex-col items-center justify-center group">
                        <span class="group-hover:scale-105 transition-transform">ğŸ–¨ï¸ æ‰¹é‡å‡ºç¥¨</span>
                        <span class="text-[10px] font-normal opacity-80">å‘é€è‡³é˜Ÿåˆ—</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let parsedTickets = [];

        // ç®€å•çš„æ—¥å¿—å·¥å…·
        function log(htmlMsg) {
            const div = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            div.innerHTML += `<div><span class="text-slate-500">[${time}]</span> ${htmlMsg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        // å¯¼å…¥æ¼”ç¤ºæ•°æ®
        function importMock() {
            document.getElementById('rawInput').value = 
`3001-3
3002-1
3003-0
å‘¨ä¸‰004:3:0
å‘¨å››005-èƒœå¹³
3006-2:1`;
            log("âœ… å·²å¯¼å…¥æ¼”ç¤ºæ•°æ®æ¨¡æ¿");
        }

        // è°ƒç”¨åå°è§£æ
        async function parseText() {
            const raw = document.getElementById('rawInput').value;
            const delimiter = document.getElementById('delimiter').value;

            if(!raw.trim()) return alert("è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥æ¡†ç²˜è´´æ•°æ®ï¼");
            
            log("â³ æ­£åœ¨æäº¤è§£æè¯·æ±‚...");
            try {
                // æ³¨æ„ï¼šè¿™é‡Œé€šå¸¸åç«¯ä¸éœ€è¦ delimiter å‚æ•°ï¼Œåç«¯ä¼šè‡ªåŠ¨åˆ¤æ–­ï¼Œæˆ–ä½ å¯ä»¥ä¼ è¿‡å»
                // è¿™é‡Œä¸ºäº†å…¼å®¹ä¹‹å‰çš„ parser.py é€»è¾‘ï¼Œæˆ‘ä»¬ç›´æ¥ä¼  content
                const res = await fetch('/api/batch/parse', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content: raw})
                });
                const data = await res.json();
                
                parsedTickets = data.tickets;
                renderTable(data.tickets);
                
                if(data.errors.length > 0) {
                    log(`<span class="text-yellow-400">âš ï¸ è§£æå®Œæˆï¼Œä½†æœ‰ ${data.errors.length} è¡Œè¢«è·³è¿‡</span>`);
                    data.errors.forEach(e => log(`<span class="text-red-400 pl-4">âŒ ${e}</span>`));
                } else {
                    log(`<span class="text-white">âœ… è§£ææˆåŠŸï¼å…± ${data.tickets.length} æ¡æœ‰æ•ˆæ•°æ®</span>`);
                }
            } catch(e) {
                log(`<span class="text-red-500">âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${e.message}</span>`);
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(list) {
            const tbody = document.getElementById('listBody');
            tbody.innerHTML = '';
            
            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-slate-400 py-10">æ²¡æœ‰è§£æåˆ°æœ‰æ•ˆæ•°æ®</td></tr>';
                document.getElementById('validCount').innerText = 0;
                return;
            }

            list.forEach(t => {
                // æ ¼å¼åŒ–æ˜¾ç¤ºæŠ•æ³¨è¯¦æƒ…
                let detail = t.bets.map(b => 
                    `<span class="bg-slate-100 text-slate-600 px-1 rounded border border-slate-200 text-xs">` +
                    `${b.match} &gt; ${b.type} = <span class="text-blue-600 font-bold">${b.choice}</span>` +
                    `</span>`
                ).join(' ');

                tbody.innerHTML += `
                    <tr class="transition hover:bg-blue-50">
                        <td class="text-center text-slate-500">${t.id}</td>
                        <td class="font-mono text-xs">${t.raw.split(/[-:]/)[0] || 'Unknown'}</td>
                        <td class="font-mono font-bold text-slate-700">${t.bets[0].match}</td>
                        <td>${detail}</td>
                        <td class="text-center"><span class="text-green-600 font-bold text-xs bg-green-50 px-2 py-0.5 rounded border border-green-200">æ­£å¸¸</span></td>
                    </tr>
                `;
            });
            document.getElementById('validCount').innerText = list.length;
        }

        // æ‰¹é‡æ‰“å°
        async function startBatchPrint() {
            if(parsedTickets.length === 0) return alert("åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•æ‰“å°ï¼\nè¯·å…ˆå½•å…¥æ•°æ®å¹¶ç‚¹å‡»è§£æã€‚");
            
            const gPass = document.getElementById('gPass').value;
            const gMulti = document.getElementById('gMulti').value;
            
            if(!confirm(`ç¡®è®¤å¼€å§‹æ‰“å°ä»»åŠ¡ï¼Ÿ\n\n----------------\nç¥¨æ•°: ${parsedTickets.length} å¼ \nè¿‡å…³: ${gPass}\nå€æ•°: ${gMulti} å€\n----------------\n\nè¯·ç¡®ä¿æ‰“å°æœºçº¸å¼ å……è¶³ã€‚`)) return;
            
            log("ğŸš€ æ­£åœ¨å‘é€è‡³æ‰“å°é˜Ÿåˆ—...");
            try {
                const res = await fetch('/api/batch/print', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tickets: parsedTickets,
                        passType: gPass,
                        multiplier: gMulti
                    })
                });
                const d = await res.json();
                if(d.status === 'ok') {
                    log(`<span class="text-green-400">âœ… ä»»åŠ¡å·²æäº¤ï¼${d.queued_count} å¼ ç¥¨æ®æ­£åœ¨åå°æ‰“å°ä¸­...</span>`);
                } else {
                    log(`<span class="text-red-500">âŒ æäº¤å¤±è´¥: ${d.msg}</span>`);
                }
            } catch(e) {
                log(`<span class="text-red-500">âŒ ç½‘ç»œé”™è¯¯</span>`);
            }
        }
    </script>
</body>
</html>
