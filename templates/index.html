<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrintBet Studio Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f1f5f9; user-select: none; }
        
        /* 模拟热敏纸 */
        .receipt-paper {
            background: #fff; font-family: 'Consolas', monospace; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-size: 12px; line-height: 1.5;
            border-top: 1px dashed #e2e8f0; min-height: 400px;
        }
        .omr-mark { background: #000; color: #fff; padding: 0 2px; font-weight: bold; }
        
        /* 弹窗过渡 */
        .modal { transition: opacity 0.2s ease-in-out; pointer-events: none; opacity: 0; }
        .modal.open { pointer-events: auto; opacity: 1; }
        
        /* 顶部 Tab 激活态 */
        .tab-btn.active { background: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37,99,235,0.3); }
        
        /* 设置中心左侧导航激活态 */
        .settings-nav-item { cursor: pointer; padding: 12px 20px; border-left: 4px solid transparent; color: #64748b; font-weight: 600; transition: all 0.2s; }
        .settings-nav-item:hover { background: #f8fafc; color: #334155; }
        .settings-nav-item.active { border-left-color: #2563eb; color: #2563eb; background: #eff6ff; }
        
        /* 选号球 */
        .ball { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid #cbd5e1; border-radius: 50%; cursor: pointer; font-weight: bold; color: #475569; transition: all 0.1s; }
        .ball.active { background: #ef4444; color: white; border-color: #ef4444; box-shadow: 0 2px 4px rgba(239,68,68,0.3); }
        .ball.rect { border-radius: 6px; width: auto; padding: 0 12px; height: 32px; font-size: 12px; }
        .ball.rect.active { background: #22c55e; color: white; border-color: #22c55e; box-shadow: 0 2px 4px rgba(34,197,94,0.3); }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800">

    <!-- 1. 顶部导航 -->
    <header class="bg-slate-900 text-white h-14 flex items-center px-4 justify-between shadow-lg z-30">
        <div class="flex items-center gap-3 font-bold text-lg tracking-wide">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-sm"><i class="fa-solid fa-print"></i></div>
            PrintBet Studio
        </div>
        <div class="flex bg-slate-800 p-1 rounded-lg gap-1">
            <button onclick="switchMode('football')" id="tab-football" class="tab-btn active px-4 py-1.5 rounded text-xs font-bold transition"><i class="fa-regular fa-futbol mr-1"></i> 竞彩足球</button>
            <button onclick="switchMode('basketball')" id="tab-basketball" class="tab-btn px-4 py-1.5 rounded text-xs font-bold transition"><i class="fa-solid fa-basketball mr-1"></i> 竞彩篮球</button>
            <button onclick="switchMode('number')" id="tab-number" class="tab-btn px-4 py-1.5 rounded text-xs font-bold transition"><i class="fa-solid fa-ticket mr-1"></i> 数字彩票</button>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex flex-col items-end text-[10px] text-slate-400 font-mono leading-tight cursor-help" title="连接状态">
                <div class="flex items-center gap-1">OCR <span class="w-2 h-2 rounded-full bg-gray-500 transition-colors" id="led-ocr"></span></div>
                <div class="flex items-center gap-1">PRN <span class="w-2 h-2 rounded-full bg-gray-500 transition-colors" id="led-prn"></span></div>
            </div>
            <button onclick="openSettings()" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center transition text-slate-300 hover:text-white">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </header>

    <!-- 2. 主界面 -->
    <div class="flex-1 flex overflow-hidden">
        <!-- 左侧编辑区 -->
        <main class="flex-1 flex flex-col bg-white border-r border-slate-200 relative z-10">
            <div class="h-14 border-b border-slate-100 flex items-center justify-between px-6 bg-slate-50/50">
                <div class="flex gap-4 items-center" id="global-config-area">
                    <div class="flex items-center gap-2 bg-white border border-slate-200 rounded px-2 py-1 shadow-sm">
                        <label class="text-xs font-bold text-slate-400 uppercase">Pass</label>
                        <select id="passType" class="text-sm font-bold text-slate-700 bg-transparent outline-none w-24">
                            <option value="1x1">单关</option>
                            <option value="2x1">2串1</option>
                            <option value="3x1">3串1</option>
                            <option value="4x1">4串1</option>
                            <option value="5x1">5串1</option>
                            <option value="6x1">6串1</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 bg-white border border-slate-200 rounded px-2 py-1 shadow-sm">
                        <label class="text-xs font-bold text-slate-400 uppercase">Multi</label>
                        <input type="number" id="multiplier" value="10" class="text-sm font-bold text-blue-600 bg-transparent outline-none w-12 text-center">
                    </div>
                </div>
                <button onclick="startOCR()" class="text-slate-500 hover:text-blue-600 text-sm font-bold flex items-center gap-2 transition px-3 py-1 rounded hover:bg-blue-50">
                    <i class="fa-solid fa-camera"></i> 截图识别
                </button>
            </div>

            <div class="grid grid-cols-12 gap-4 px-6 py-2 bg-slate-100 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-200">
                <div class="col-span-2">Match ID</div>
                <div class="col-span-2">Play Type</div>
                <div class="col-span-7">Selection</div>
                <div class="col-span-1 text-right">Action</div>
            </div>

            <div id="ticket-rows" class="flex-1 overflow-y-auto px-6 py-3 space-y-2"></div>

            <div class="p-4 border-t border-slate-100 bg-slate-50/80 backdrop-blur-sm flex flex-col gap-3">
                <button onclick="addNewRow()" class="w-full border-2 border-dashed border-slate-300 rounded-lg py-2 text-slate-400 hover:border-blue-500 hover:text-blue-500 transition font-bold text-sm">
                    <i class="fa-solid fa-plus"></i> 添加比赛 / 号码
                </button>
                <div class="flex items-center justify-between pt-2">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Estimated Cost</div>
                        <div class="text-2xl font-bold text-slate-800 leading-none">¥ <span id="total-amount">0</span></div>
                    </div>
                    <button onclick="doPrint()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-print"></i> 立即出票
                    </button>
                </div>
            </div>
        </main>

        <!-- 右侧预览区 -->
        <aside class="w-[380px] bg-slate-100 border-l border-slate-200 flex flex-col shadow-inner">
            <div class="p-3 border-b border-slate-200 bg-white flex justify-between items-center">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Terminal Preview</h3>
                <div class="text-[10px] text-slate-300 font-mono" id="preview-time">--:--</div>
            </div>
            <div class="flex-1 p-6 overflow-y-auto flex justify-center">
                <div class="receipt-paper w-full flex flex-col">
                    <div class="text-center font-bold text-base mb-1">PrintBet OMR</div>
                    <div class="text-center text-[10px] text-slate-400 mb-4 border-b border-dashed pb-2">Official Simulation</div>
                    
                    <!-- OMR 图片预览容器 -->
                    <div class="flex-1 flex items-center justify-center min-h-[200px] bg-slate-50 border border-dashed border-slate-200 rounded p-2">
                        <img id="omr-preview-img" class="w-full opacity-90" alt="OMR Preview" style="display:none;">
                        <span id="omr-placeholder" class="text-xs text-slate-300">等待数据...</span>
                    </div>

                    <div class="border-t border-dashed border-slate-300 mt-6 pt-4">
                        <div class="text-center font-bold text-xs mb-2">Scan to Terminal:</div>
                        <div id="qrcode" class="flex justify-center p-2 bg-white border rounded"></div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- ================= 万能选号器 ================= -->
    <div id="picker-modal" class="modal fixed inset-0 bg-black/60 z-40 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-[650px] max-h-[85vh] flex flex-col">
            <div class="h-14 border-b px-6 flex items-center justify-between bg-slate-50 rounded-t-xl">
                <div><h3 class="font-bold text-slate-700" id="picker-title">选择内容</h3></div>
                <button onclick="closePicker()" class="text-slate-400 hover:text-red-500 text-lg"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex-1 p-6 overflow-y-auto bg-white" id="picker-content"></div>
            <div class="p-4 border-t bg-slate-50 rounded-b-xl flex justify-end">
                <button onclick="confirmPicker()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow">确认选择</button>
            </div>
        </div>
    </div>

    <!-- ================= 系统设置中心 (修复版) ================= -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-white rounded-xl shadow-2xl w-[700px] h-[500px] flex overflow-hidden">
            
            <!-- 左侧导航 -->
            <div class="w-48 bg-slate-50 border-r border-slate-200 py-4 flex flex-col">
                <div class="px-6 mb-4 text-xs font-bold text-slate-400 uppercase">Settings</div>
                <div class="settings-nav-item active" id="nav-hardware" onclick="switchSettingsTab('hardware')"><i class="fa-solid fa-plug w-5"></i> 硬件连接</div>
                <div class="settings-nav-item" id="nav-prefs" onclick="switchSettingsTab('prefs')"><i class="fa-solid fa-sliders w-5"></i> 操作偏好</div>
                <div class="settings-nav-item" id="nav-system" onclick="switchSettingsTab('system')"><i class="fa-solid fa-circle-info w-5"></i> 系统更新</div>
            </div>

            <!-- 右侧内容区 -->
            <div class="flex-1 flex flex-col bg-white">
                <div class="h-14 border-b flex items-center justify-between px-6">
                    <span class="font-bold text-slate-700 text-lg">配置面板</span>
                    <button onclick="closeSettings()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="flex-1 p-6 overflow-y-auto relative">
                    
                    <!-- 1. 硬件连接面板 -->
                    <div id="panel-hardware" class="settings-panel block">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">热敏打印机</label>
                                <div class="flex gap-2">
                                    <select id="cfg-printer" class="flex-1 border rounded px-3 py-2 text-sm outline-none bg-white"></select>
                                    <button onclick="testPrinter()" class="bg-slate-100 border px-4 rounded text-xs font-bold hover:bg-slate-200">测试</button>
                                </div>
                                <p class="text-xs text-slate-400 mt-1">若未找到，请检查 USB 连接或驱动。</p>
                            </div>
                            <div class="h-px bg-slate-100"></div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">OCR 接口地址</label>
                                <div class="flex gap-2">
                                    <input id="cfg-ocr" type="text" class="flex-1 border rounded px-3 py-2 text-sm outline-none font-mono">
                                    <button onclick="testOCR()" class="bg-slate-100 border px-4 rounded text-xs font-bold hover:bg-slate-200">测试</button>
                                </div>
                                <p class="text-xs text-slate-400 mt-1">默认: http://127.0.0.1:1224/api/ocr (需开启 Umi-OCR HTTP服务)</p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 操作偏好面板 -->
                    <div id="panel-prefs" class="settings-panel hidden">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">默认过关方式</label>
                                <select id="cfg-pass" class="w-full border rounded px-3 py-2 text-sm"><option>2x1</option><option>3x1</option></select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">默认倍数</label>
                                <input id="cfg-multi" type="number" class="w-full border rounded px-3 py-2 text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- 3. 系统更新面板 -->
                    <div id="panel-system" class="settings-panel hidden text-center pt-4">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-slate-400"><i class="fa-solid fa-rocket"></i></div>
                        <h3 class="font-bold text-xl text-slate-800">PrintBet Studio</h3>
                        <p class="text-sm text-slate-500 mb-6" id="app-version-display">Loading...</p>
                        <button onclick="checkUpdate()" class="bg-slate-800 text-white px-6 py-2 rounded-full text-sm font-bold hover:bg-black transition">检查更新</button>
                        <div id="update-status" class="mt-4 text-xs text-slate-500"></div>
                    </div>

                </div>

                <div class="p-4 border-t bg-slate-50 flex justify-end gap-3">
                    <button onclick="closeSettings()" class="px-4 py-2 text-sm text-slate-500 font-bold hover:text-slate-800">取消</button>
                    <button onclick="saveConfig()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold text-sm shadow">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-mask" class="fixed inset-0 bg-white/80 z-[100] hidden flex-col items-center justify-center backdrop-blur-sm">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
        <div class="text-slate-600 font-bold animate-pulse" id="loading-text">Processing...</div>
    </div>

    <script>
        let currentMode = 'football';
        let tickets = [];
        let activeRowIndex = -1;
        let tempChoice = '';

        const CONFIG = {
            football: { types: [{k:'SPF',v:'胜平负'},{k:'RQSPF',v:'让球'},{k:'CBF',v:'比分'},{k:'JQS',v:'总进球'},{k:'BQC',v:'半全场'}], defaults: {match:'周三001',type:'SPF',choice:'胜'} },
            basketball: { types: [{k:'SF',v:'胜负'},{k:'RFSF',v:'让分'},{k:'DXF',v:'大小分'},{k:'SFC',v:'胜分差'}], defaults: {match:'周三301',type:'SF',choice:'主胜'} },
            number: { types: [{k:'P3',v:'排列三'},{k:'P5',v:'排列五'},{k:'DLT',v:'大乐透'}], defaults: {match:'23125期',type:'P3',choice:'1,2,3'} }
        };

        // === 核心逻辑 ===
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.getElementById('passType').parentElement.style.visibility = mode === 'number' ? 'hidden' : 'visible';
            tickets = []; addNewRow();
        }

        function updateUI() {
            const container = document.getElementById('ticket-rows');
            container.innerHTML = '';
            tickets.forEach((t, idx) => {
                const opts = CONFIG[currentMode].types.map(o => `<option value="${o.k}" ${t.type===o.k?'selected':''}>${o.v}</option>`).join('');
                const row = `<div class="grid grid-cols-12 gap-2 items-center bg-white p-2 rounded border border-slate-200 shadow-sm hover:border-blue-400 transition group">
                    <div class="col-span-2"><input value="${t.match}" onchange="updTicket(${idx},'match',this.value)" class="w-full border rounded px-2 py-1 text-sm font-mono font-bold text-slate-700 outline-none focus:border-blue-500"></div>
                    <div class="col-span-2"><select onchange="updTicket(${idx},'type',this.value)" class="w-full border rounded px-2 py-1 text-sm outline-none">${opts}</select></div>
                    <div class="col-span-7" onclick="openPicker(${idx})"><div class="w-full border bg-slate-50 rounded px-3 py-1 text-sm cursor-pointer hover:bg-white hover:border-blue-500 text-blue-700 font-bold truncate flex justify-between items-center h-[30px]">${formatChoice(t.type, t.choice)} <i class="fa-solid fa-chevron-right text-[10px] text-slate-300"></i></div></div>
                    <div class="col-span-1 text-right"><button onclick="delRow(${idx})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>
                </div>`;
                container.insertAdjacentHTML('beforeend', row);
            });
            document.getElementById('total-amount').innerText = tickets.length * 2 * document.getElementById('multiplier').value;
            refreshOMRPreview();
        }

        function formatChoice(type, val) { return val || '点击选择...'; }
        function updTicket(i, k, v) { tickets[i][k] = v; updateUI(); }
        function addNewRow() { tickets.push({...CONFIG[currentMode].defaults}); updateUI(); }
        function delRow(i) { tickets.splice(i, 1); updateUI(); }

        // === OMR 预览 ===
        async function refreshOMRPreview() {
            const imgEl = document.getElementById('omr-preview-img');
            const ph = document.getElementById('omr-placeholder');
            if(tickets.length === 0) { imgEl.style.display='none'; ph.style.display='block'; return; }

            try {
                const res = await fetch('/api/preview_omr', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({bets:tickets, passType:document.getElementById('passType').value, multiplier:document.getElementById('multiplier').value})
                });
                const d = await res.json();
                if(d.status==='ok' && d.img_base64) {
                    imgEl.src = "data:image/png;base64," + d.img_base64;
                    imgEl.style.display='block'; ph.style.display='none';
                }
            } catch(e){}
        }

        async function doPrint() {
            if(tickets.length===0) return alert("无内容");
            showLoading(true, "Printing...");
            try {
                const res = await fetch('/api/print', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({bets:tickets, passType:document.getElementById('passType').value, multiplier:document.getElementById('multiplier').value})
                });
                const d = await res.json();
                if(d.status==='ok') { alert("已发送至打印机"); } else { alert(d.msg); }
            } catch(e){ alert("Network Error"); }
            finally { showLoading(false); }
        }

        // === 设置中心逻辑 (修复版) ===
        function switchSettingsTab(tab) {
            // 1. 移除所有导航的 active
            document.querySelectorAll('.settings-nav-item').forEach(el => el.classList.remove('active'));
            // 2. 移除所有面板的 hidden 并添加 hidden (重置)
            document.querySelectorAll('.settings-panel').forEach(el => el.classList.add('hidden'));
            
            // 3. 激活当前
            document.getElementById(`nav-${tab}`).classList.add('active');
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
        }

        async function openSettings() {
            // 强制先显示，防止死锁
            document.getElementById('settings-modal').classList.remove('hidden');
            
            try {
                const res = await fetch('/api/config/get');
                const d = await res.json();
                if(d.status==='error') throw new Error(d.msg);
                
                // 填充打印机
                const sel = document.getElementById('cfg-printer'); sel.innerHTML='';
                (d.printers || []).forEach(p => {
                    const op = document.createElement('option'); op.value=p; op.innerText=p;
                    if(p===d.config.printer_name) op.selected=true;
                    sel.appendChild(op);
                });
                
                // 填充其他
                document.getElementById('cfg-ocr').value = d.config.ocr_url || '';
                document.getElementById('cfg-pass').value = d.config.default_pass_type || '2x1';
                document.getElementById('cfg-multi').value = d.config.default_multiplier || 10;
                document.getElementById('app-version-display').innerText = d.app_version;
                
                checkStatus();
            } catch(e) { 
                console.error(e); 
                // 不要在 openSettings 里 alert，否则会卡住界面，只在控制台报错即可，或者在 Modal 里显示错误红字
            }
        }

        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

        async function saveConfig() {
            const cfg = {
                printer_name: document.getElementById('cfg-printer').value,
                ocr_url: document.getElementById('cfg-ocr').value,
                default_pass_type: document.getElementById('cfg-pass').value,
                default_multiplier: document.getElementById('cfg-multi').value
            };
            await fetch('/api/config/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(cfg)});
            closeSettings();
            checkStatus();
            alert("配置已保存");
        }

        // 辅助功能
        function showLoading(s, t) { document.getElementById('loading-mask').style.display=s?'flex':'none'; document.getElementById('loading-text').innerText=t; }
        async function checkStatus() {
            try {
                const ocrOk = document.getElementById('cfg-ocr').value.includes('http');
                const prnOk = !!document.getElementById('cfg-printer').value;
                document.getElementById('led-ocr').className = `w-2 h-2 rounded-full ${ocrOk?'bg-green-500':'bg-red-500'}`;
                document.getElementById('led-prn').className = `w-2 h-2 rounded-full ${prnOk?'bg-green-500':'bg-red-500'}`;
            } catch(e){}
        }
        async function mockOCR() { alert("请先在设置中配置 OCR"); }
        async function checkUpdate() { alert("暂无更新"); }
        async function testPrinter() { alert("测试指令已发送"); }
        async function testOCR() { alert("OCR 连接测试中..."); }

        // Init
        switchMode('football');
        window.onload = openSettings; // 首次加载尝试加载配置(静默)后立即关闭，或者直接 checkStatus
        setTimeout(()=> { closeSettings(); checkStatus(); }, 500); 
        
        // 选号器相关 (保留基础框架，避免报错)
        function openPicker(idx) { activeRowIndex=idx; tempChoice=tickets[idx].choice; document.getElementById('picker-modal').classList.add('open'); renderBasicGrid(); }
        function closePicker() { document.getElementById('picker-modal').classList.remove('open'); }
        function confirmPicker() { tickets[activeRowIndex].choice = tempChoice; updateUI(); closePicker(); }
        function renderBasicGrid() { 
            const c = document.getElementById('picker-content'); c.innerHTML='';
            const d = document.createElement('div'); d.className='flex gap-4';
            ['3','1','0'].forEach(v => {
                const b = document.createElement('div'); b.className=`ball rect w-24 h-12 ${tempChoice==v?'active':''}`;
                b.innerText=v; b.onclick=()=>{tempChoice=v; document.querySelectorAll('.ball').forEach(x=>x.classList.remove('active')); b.classList.add('active');};
                d.appendChild(b);
            });
            c.appendChild(d);
        }
    </script>
</body>
</html>
